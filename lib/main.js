/**
 * 
 *   This file is part of Vtro.
 *   Copyright (C) 2020  wk989898
 *   
 *   Vtro is free software: you can redistribute it and/or modify
 *   it under the terms of the GNU General Public License as published by
 *   the Free Software Foundation, either version 3 of the License, or
 *   (at your option) any later version.
 *   
 *   This program is distributed in the hope that it will be useful,
 *   but WITHOUT ANY WARRANTY; without even the implied warranty of
 *   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 *   GNU General Public License for more details.
 *   
 *   You should have received a copy of the GNU General Public License
 *   along with this program.  If not, see <https://www.gnu.org/licenses/>.
 *   
 */

"use strict";const{app:e,BrowserWindow:o,ipcMain:n,Menu:t,Tray:r,shell:i}=require("electron"),s=require("path"),l=require("fs"),a=require("child_process"),c=require("http"),d=(require("https"),require("process")),p=require("dns");var g,u,f,y,h={isIP:!0,fast_open:!1,reuse_port:!1,reuse_session:!0};const w=c.createServer();function S(){(g=new o({width:800,height:600,webPreferences:{nodeIntegration:!0,devTools:!0}})).loadFile("index.html"),g.on("close",e=>{e.preventDefault(),g.hide()})}function x(e){return Object.prototype.toString.call(e).slice(8).replace("]","").toLowerCase()}function j(o){let n=e.isPackaged?s.resolve(e.getPath("exe"),"../"):"";return s.resolve(n,o)}function b(e,o){e&&(null==o&&(o=j("./trojan/log.txt")),l.appendFile(o,function(...e){const[o="-",n=" ",t=":"]=e,r=new Date;return r.getFullYear().toString()+o+r.getMonth().toString().padStart(2,"0")+o+r.getDay().toString().padStart(2,"0")+n+r.getHours().toString().padStart(2,"0")+t+r.getMinutes().toString().padStart(2,"0")+t+r.getSeconds().toString().padStart(2,"0")}()+e+"\n","utf-8",()=>{}))}function m(e,o,n){a.execFile("./sysproxy.exe",[e,o,n],{cwd:j("./proxy"),windowsHide:!0},(e,o,n)=>{e&&b(e)&&w.close(),n&&b(n)})}function v(){y=a.execFile("./privoxy.exe",{cwd:j("./proxy"),windowsHide:!0},e=>{e&&b("privoxy error!has you close privoxy?\nplease check http://localhost:1081\n")&&w.close()}),y.pid}function _(){f&&f.kill(),y&&y.kill(),w.listening&&w.close()}async function F(e,o,n){return o?(await N("a",null,t=>{n&&n(t),"array"===x(o)?t[e].unshift(...o):t[e].unshift(o)}),Promise.resolve(!0)):(b("there is no data to be added"),Promise.resolve(!1))}function k(e,o){N("a",null,n=>{"array"===x(n[e])&&(n[e]=n[e].filter(e=>o(e)))})}async function N(e,o="",n){let t=j("./trojan/conf.json");return"r"===e?await l.readFile(t,"utf-8",(e,o)=>{e&&b(e),o=JSON.parse(o.toString()),n(o)}):"w"===e?await l.writeFile(t,JSON.stringify(o),e=>{e&&b(e)}):"a"===e?await l.readFile(t,"utf-8",(e,o)=>{e&&b(e),o=JSON.parse(o.toString()),n(o),l.writeFileSync(t,JSON.stringify(o))}):void 0}e.name="Vtro",e.requestSingleInstanceLock()?(e.on("second-instance",(e,o,n)=>{g&&(g.isMinimized()&&g.restore(),g.focus(),g.show())}),e.on("ready",()=>{S();const o=e.isPackaged;!o&&g.webContents.openDevTools(),u=new r(o?s.resolve(e.getAppPath(),"../tray.ico"):"tray.ico");let n=[{label:"退出",click(){e.exit()}}];const i=t.buildFromTemplate(n);u.setToolTip("Vtro"),u.addListener("click",()=>{g.show()}),u.setContextMenu(i),u.on("click",()=>{!g.isVisible()&&g.show()})})):e.quit(),e.on("before-quit",()=>{_()}),e.on("window-all-closed",(function(o){"darwin"!==d.platform&&e.quit()})),e.on("activate",(function(){0===o.getAllWindows().length&&S()})),w.on("request",(e,o)=>{"/pac"===e.url&&(o.setHeader("Content-Type","application/x-ns-proxy-autoconfig"),l.readFile(j("./proxy/proxy.pac"),(e,n)=>{e&&o.end("error"),o.end(n)}))});let P=0,q=0;function O(e=e){e.stderr.on("data",e=>{e.replace(/(\d*) bytes received, (\d*) bytes sent/,(e,o,n)=>{var t,r;o&&n&&(P+=Number(o),q+=Number(n),t="flow",r=[P,q],g.webContents.send(t,r))})}).on("close",()=>{P=0,q=0})}n.on("link",(e,o)=>{let n;_(),l.readFile(j("./trojan/config.json"),"utf-8",(e,o)=>{e&&b(e);let n=JSON.parse(o.toString());N("r",null,async e=>{let o;const{isIP:t=!0,fast_open:r=!1,reuse_port:i=!1,reuse_session:s=!0}=h;o=e.config.night.ip&&"night"===e.config.mode?e.config.night:e.config.day,n.remote_addr=t?o.ip:o.addr,n.remote_port=o.port,n.password[0]=o.password,n.local_port=e.config.listen[0]||1080,n.tcp.reuse_port=i,n.tcp.fast_open=r,n.ssl.reuse_session=s,await l.writeFile(j("./trojan/config.json"),JSON.stringify(n),"utf-8",e=>{e&&b(e)})})}),O(f=a.execFile("trojan.exe",{cwd:j("./trojan"),windowsHide:!0},(e,o,n)=>{n&&b(n,j("./trojan/trojan-log.txt"))})),f.pid,N("r",null,e=>{const o=e.config.proxy||"pac",[t,r=1081,i=1082]=e.config.listen;if("global"===o){n=`http://127.0.0.1:${r}`,m(o,n,"localhost;127.*"),v()}else"pac"===o?(n=`http://127.0.0.1:${i}/pac`,!w.listening&&w.listen(i,"127.0.0.1",()=>{m(o,n),v()})):m("set",1)}),e.reply("linked"),console.log("trojan open")}).on("close",(e,o)=>{_(),e.reply("closed"),console.log("trojan closed")}),n.on("get-nodes",e=>{N("r",null,o=>{if(!o.nodes)return b("please check your conf.json");e.reply("update-nodes",o.nodes)})}).on("change-linkNode",(e,o)=>{o&&N("a",null,n=>{n.config.day=o,e.reply("config",n.config)})}).on("change-nightNode",(e,o)=>{o&&N("a",null,n=>{n.config.night=o,e.reply("config",n.config)})}).on("change-mode",(e,o)=>{N("a",null,n=>{n.config.mode=o,e.reply("update-mode")})}),n.on("get-sub",e=>{N("r",null,o=>{e.reply("subs",o.sub||[])})}).on("update",(e,o)=>{F("nodes",o.nodes,e=>{e.nodes.length=0}).finally(e=>{setTimeout(()=>{F("sub",o.sub,e=>{e.sub.length=0})},1e3)})}).on("remove-sub",(e,o)=>{k("sub",e=>e!==o),e.reply("removed")}).on("sub-proxy",(e,o)=>{o?l.readFile(j("./trojan/config.json"),async(e,o)=>{e&&b(e);const{local_addr:n,local_port:t}=JSON.parse(o.toString());let r=`socks://${n}:${t},localhost`;g.webContents.session.setProxy({proxyRules:r})}):g.webContents.session.setProxy({})}),n.on("add-node",(e,o)=>{o.ip?F("nodes",o):p.resolve4(o.addr,(e,n)=>{e&&(o.ip="0"),"array"===x(n)&&(n=n[0]),o.ip=n,F("nodes",o)})}).on("delete-node",(e,o)=>{k("nodes",e=>e.ip?e.ip!==o:e.addr!=e.addr),e.reply("deleted")}).on("update-node",(e,o)=>{N("a",null,e=>{e.nodes=o})}),n.on("getConf",e=>{N("r",null,o=>{e.reply("config",o.config)})}).on("setConf",(e,o)=>{N("a",null,n=>{Object.assign(n.config,o),e.reply("config",n.config)})}),n.on("set-login",(o,n)=>{e.isPackaged?e.setLoginItemSettings({openAsHidden:!0,openAtLogin:n}):e.setLoginItemSettings({openAtLogin:n,openAsHidden:!0})}).on("get-login",o=>{o.reply("login",e.getLoginItemSettings().openAtLogin)}).on("other",(e,[o,n])=>{o in h&&(h[o]=n)}),n.on("pac",e=>{a.exec("node fetchPAC.js",{cwd:j("./proxy"),windowsHide:!0},(e,o,n)=>{e&&b("更新pac失败"),b(o)})}).on("trojan-log",e=>{i.openItem(j("trojan/trojan-log.txt"))}).on("link-log",e=>{i.openItem(j("trojan/log.txt"))}).on("change_log_level",(e,o)=>{l.readFile(j("trojan/config.json"),(e,n)=>{e&&b(e);let t=JSON.parse(n);t.log_level=o,l.writeFile(j("trojan/config.json"),JSON.stringify(t),e=>{})})}).on("get_log_level",e=>{l.readFile(j("trojan/config.json"),(o,n)=>{o&&b(o);const t=JSON.parse(n).log_level;e.reply("log_level",t)})});var C=null;e.isPackaged||(C=t.buildFromTemplate([{id:"refresh",label:"refresh",role:"forceReload"}])),t.setApplicationMenu(C);
//# sourceMappingURL=main.js.map
